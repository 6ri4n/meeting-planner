const meetingElement=document.getElementById("meeting"),meeting=JSON.parse(meetingElement.textContent),participantsElement=document.getElementById("participants"),participants=JSON.parse(participantsElement.textContent),renderGrid=handleGrid(),{select:e,setSelection:t}=selectionState(),{getTimezone:i,setTimezone:a}=timezoneState(),eventId=window.location.pathname.substring(1),debouncedHandleUpdateReq=debounce(handleUpdateReq,3e3);let user;function loadTimezone(){let e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=document.getElementById("timezone");for(let n=0;n<t.options.length;n++)if(t.options[n].value===e){t.selectedIndex=n,a(t.value),updateDisplayTime(i());break}t.addEventListener("change",()=>{a(t.value),updateDisplayTime(i())})}function updateDisplayTime(e){let t=document.querySelectorAll("#display-times div");for(let i=0;i<=meeting.times.length-1;i++){let a=n(meeting.times[i],e).split(", ")[1];t[i].textContent=a,user&&(t[i+meeting.times.length].textContent=a)}function n(e,t){let i=new Date().toISOString().split("T")[0],a=`${i}T${e}:00Z`,n=new Date(a);return new Intl.DateTimeFormat("en-US",{timeZone:t,dateStyle:"short",timeStyle:"short"}).format(n)}}function handleGrid(){return function e(t){let i=Object.entries(meeting.days),a=document.querySelector(`#${t} #available-days`),n=document.querySelector(`#${t} #available-times`),l=document.querySelector(`#${t} #display-times`);for(let r of meeting.times){let d=document.createElement("div");d.id=d.textContent=r,l.appendChild(d)}for(let[s,[o,c]]of i.entries()){let p=document.createElement("div"),m=document.createElement("div"),u=document.createElement("div");m.textContent=`${c.monthLong.substring(0,3)} ${c.day}`,u.textContent=`${c.dayLong.substring(0,3)}`,p.className="available-day",p.append(m,u),a.appendChild(p);let g=document.createElement("div");for(let[h,v]of(g.className="available-time-col",meeting.times.entries())){let y=document.createElement("div"),f=(s+1).toString(),b=(h+1).toString();y.id=o,y.className="available-time",y.setAttribute("data-col",f),y.setAttribute("data-row",b),y.addEventListener("dragstart",e=>{e.preventDefault()}),"edit-main-content"===t?g.appendChild(initHighlight(y,f,b)):"view-main-content"===t&&g.appendChild(handleDisplayAvailability(y,f,b))}n.appendChild(g)}}}function updateDisplayAvailability(){let e=document.querySelectorAll("#view-main-content .available-time-col .available-time");for(let t of e){t.classList="available-time";let i=t.getAttribute("data-col"),a=t.getAttribute("data-row");handleDisplayAvailability(t,i,a)}}function handleDisplayAvailability(e,t,i){let a=Object.entries(participants).length,n=0;for(let[l,r]of Object.entries(participants))r[e.id]?.find(({col:e,row:a})=>t===e&&i===a)&&(n+=1);return a>0&&n===a?e.classList.add("all-participants"):n>=Math.ceil(.5*a)&&n<Math.ceil(.99*a)?e.classList.add("most-participants"):n>=Math.ceil(.01*a)&&n<Math.ceil(.49*a)&&e.classList.add("some-participants"),e}function handleDisplayParticipants(){return{mouseover:function e(t){let i=t.target,a=t.target.getAttribute("data-row"),n=t.target.getAttribute("data-col"),l=document.querySelector("#display-participants h1"),r=document.querySelector("#display-participants p"),d=document.querySelector("#display-participants #available"),s=document.querySelector("#display-participants #unavailable"),o=document.querySelector("#display-participants"),c=Object.entries(participants).length,p=document.createElement("div"),m=document.createElement("div"),u=0;for(let[g,h]of(d.replaceChildren(),s.replaceChildren(),p.textContent="available",m.textContent="unavailable",d.appendChild(p),s.appendChild(m),Object.entries(participants))){let v=document.createElement("div");v.textContent=g,h[i.id]?.find(({col:e,row:t})=>n===e&&a===t)?(u+=1,d.appendChild(v)):s.appendChild(v)}l.textContent=`${u}/${c} Available`,r.textContent=function e(t){let[i,a,n]=t.split("-").map(Number),l=new Date(n,i-1,a),r=new Intl.DateTimeFormat("en-US",{weekday:"short",day:"2-digit",month:"short",year:"numeric"}).format(l),d=r.split(",");return`${d[0]}, ${d[1]} ${d[2]}`}(i.id),o.classList.remove("hide-display-participants")},mouseleave:function e(t){let i=document.querySelector("#display-participants");i.classList.add("hide-display-participants")}}}function handleSignIn(){document.getElementById("signin").addEventListener("submit",async e=>{e.preventDefault();let a=document.getElementById("username");if(""===a.value)return alert("Username cannot be empty.");if(a.value.length>=21)return alert("Username cannot be over 20 characters.");let n=await handleRequest("/event/signin",{eventId,username:a.value});n.ok&&(user=a.value,201===n.status&&(participants[user]={}),document.getElementById("signin").remove(),function e(){let t=document.createElement("div"),i=document.createElement("h1"),a=document.createElement("img"),n=document.createTextNode("My Availability");a.src="static/svg/calendar.svg",a.alt="Calendar Icon",i.appendChild(a),i.appendChild(n);let l=document.createElement("div");l.id="available-days";let r=document.createElement("div");r.className="filler",l.appendChild(r);let d=document.createElement("div");d.id="time-container";let s=document.createElement("div");s.id="display-times";let o=document.createElement("div");o.id="available-times",d.appendChild(s),d.appendChild(o);let c=document.createElement("section");c.id="edit-main-content",t.appendChild(i),t.appendChild(l),t.appendChild(d),c.appendChild(t);let p=document.getElementById("main-content"),m=document.getElementById("everyone-availability");p.insertBefore(c,m)}(),renderGrid("edit-main-content"),setupGridListeners("#edit-main-content",{mousedown:function e(i){let a=i.target,n=i.target.getAttribute("data-row"),l=i.target.getAttribute("data-col");t("down",a,l,n)},mouseup:function e(i){let a=i.target,n=i.target.getAttribute("data-row"),l=i.target.getAttribute("data-col");t("up",a,l,n),handleHighlight(),debouncedHandleUpdateReq()}}),updateDisplayTime(i()))})}async function handleRequest(e,t){try{let i=await fetch(`/api${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!i.ok)throw Error(`HTTP error! Status: ${i.status}`);return i}catch(a){console.error(a)}}function setupGridListeners(e,t){document.querySelectorAll(`${e} #available-times div`).forEach(e=>{if(!e.classList.contains("available-time-col"))for(let[i,a]of Object.entries(t))e.addEventListener(i,a)})}function selectionState(){let e={down:{element:void 0,col:void 0,row:void 0},up:{element:void 0,col:void 0,row:void 0}};return{select:e,setSelection:function t(i,a,n,l){("down"===i||"up"===i)&&(e[i]={element:a,col:n,row:l})}}}function timezoneState(){let e="";function t(t){e=t}return{getTimezone:()=>e,setTimezone:t}}function initHighlight(e,t,i){if(!participants[user][e.id]||!participants[user][e.id].length)return e;for(let a of participants[user][e.id])a.col===t&&a.row===i&&e.classList.add("highlight-time");return e}function handleHighlight(){let{element:t,col:i,row:a}=e.down,{col:n,row:l}=e.up,r=Math.min(i,n),d=Math.max(i,n),s=Math.min(a,l),o=Math.max(a,l),c=t.classList.contains("highlight-time"),p=document.querySelectorAll("#edit-main-content #available-times div"),m=meeting.times.length;for(let u=r;u<=d;u++){let g=u*(m+1)-m,h=g+s-1,v=g+o-1;for(let y=h;y<=v;y++)f(c,p[y]),updateDisplayAvailability()}function f(e,t){let i=t.getAttribute("data-row"),a=t.getAttribute("data-col");if(e){t.classList.remove("highlight-time");let n=participants[user][t.id].filter(e=>e.col!==a||e.row!==i);participants[user][t.id]=n}else t.classList.add("highlight-time"),participants[user][t.id]?participants[user][t.id].push({col:a,row:i}):participants[user][t.id]=[{col:a,row:i}]}}async function handleUpdateReq(){try{let e=await handleRequest("/event/update",{username:user,eventId:eventId,selectedTimes:participants[user]});e.ok||(alert("Server Error, Reloading Page."),window.location.reload())}catch(t){console.error(t),alert("Server Error, Reloading Page."),window.location.reload()}}function debounce(e,t){let i;return(...a)=>{clearTimeout(i),i=setTimeout(()=>{e(...a)},t)}}window.onload=function(){renderGrid("view-main-content"),setupGridListeners("#view-main-content",handleDisplayParticipants()),loadTimezone(),handleSignIn()};